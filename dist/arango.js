/*
 * Copyright (c) Kaerus 2012, Anders Elo <anders @ kaerus com>.
 
 * Permission is hereby granted, free of charge, to any person obtaining a 
 * copy of this software and associated documentation files (the "Software"), 
 * to deal in the Software without restriction, including without limitation 
 * the rights to use, copy, modify, merge, publish, distribute, sublicense, 
 * and/or sell copies of the Software, and to permit persons to whom the 
 * Software is furnished to do so, subject to the following conditions:

 * The above copyright notice and this permission notice shall be included in 
 * all copies or substantial portions of the Software.

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR 
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, 
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE 
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER 
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING 
 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER 
 * DEALINGS IN THE SOFTWARE.
 */

define("query",["require"],function(e){function t(e,t){e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}})}return function(e){function n(){function r(n){var i=n||t.struct;return e.filter(function(e){return i[e]?!0:!1}).map(function(e){var t=e.toUpperCase(),n=i[e];switch(t){case"FROM":t="IN";break;case"INCLUDE":t="";break;default:}if(typeof n=="object"){var s=r(n);return e==="in"?t+" ( "+s+" )":t+" "+s}return t+" "+n}).join(" ")}var e=["for","in","filter","from","include","collect","into","sort","limit","return"],t=this;e.forEach(function(e){t[e]=function(){t.struct||(t.struct={});if(!arguments.length)return t.struct[e];var r=Array.prototype.slice.call(arguments);return typeof r[0]=="function"?t.struct[e]=function(e){var t=new n;return e.apply(t),t.struct}(r[0]):t.struct[e]=r.join(" "),t}}),t.toString=r}function r(){function r(n,r){var i,s=0,o=Array.prototype.slice.call(r);return t.string?i=e.extend({query:t.string},t.options):typeof o[s]=="string"?i=e.extend({query:o[s++]},t.options):typeof o[s]=="object"&&o[s].struct?i=e.extend({query:o[s++].struct.toString()},t.options):i=e.extend({query:o[s++].toString()},t.options),typeof o[s]=="object"&&e.extend(i,{bindVars:o[s++]}),e.cursor[n](i,o[s])}var t=this;n.call(this),t.string={},t.new=function(){return new n},Object.defineProperty(this,"string",{get:function(){return t.struct?t.toString():this._string},set:function(e){this._string=e,t.struct=null}}),t.options={},t.count=function(e){return t.options.count=e>0?!0:!1,t.options.batchSize=e>0?e:undefined,t},t.test=function(){return r("query",arguments)},t.explain=function(){return r("explain",arguments)},t.exec=function(){var t=function(n){this.next=function(r){return n.id?e.cursor.get(n.id,r).on("result",t):!1}};return r("create",arguments).on("result",t)}}return t(r,n),new r}}),define("extend",["require"],function(e){function t(){var e=!1,n={},r=0;typeof arguments[r]=="boolean"&&(e=arguments[r++]),typeof arguments[r+1]=="object"&&(n=arguments[r++]);for(var i;i=arguments[r];r++)n=Object.keys(i).reduce(function(n,r){return e&&typeof i[r]=="object"?n[r]=t(!0,n[r],i[r]):n[r]=i[r],n},n);return n}return t}),define("emitter",["require"],function(e){function t(e){if(!(this instanceof t))return new t;this._events={}}return t.prototype.on=function(e,t){return e in this._events||(this._events[e]=[]),this._events[e].indexOf(t)<0&&this._events[e].push(t),this},t.prototype.off=function(e,t){if(!this._events[e])return this;var n=this._events[e].indexOf(t);return n>=0&&(this._events[e].splice(n,1),this._events[e].length===0&&delete this._events[e]),this},t.prototype.emit=function(e){if(!this._events[e])return!1;var t=Array.prototype.slice.call(arguments,1);for(var n=0,r=this._events[e].length;n<r;n++)if(this._events[e][n].apply(this,t)===!1)break;return this},t.prototype.once=function(e,t){var n=this;return this.on(e,function r(){n.off(e,r),t.apply(this,arguments)}),this},t}),define("ajax",["require","./emitter","./extend"],function(e){function i(e,t){var n={OK:[0,"ok"],NOXHR:[1e3,"Ajax is not supported"],TIMEDOUT:[1001,"operation timed out"],UNIMPLEMENTED:[1002,"no such feature"]};return{name:"Ajax",type:e,code:n[e][0],message:n[e][1]+t?":"+t:""}}function u(t,r){function h(e){this.data=[],this.data.size=0,e&&this.on("response",e)}if(s==="node"){var a=e(t.protocol||"http").request;return u=function(e,t){return delete e.protocol,a(e,t)},u(t,r)}var f=this,l,c;f.xhr=new s,f.buffer=[],f.xhr.timeout=5e3,f.xhr.ontimeout=function(e){var e=i("TIMEDOUT","after "+f.xhr.timeout+"ms");if(!f._events.error)throw e;f.emit("error",e)},h.prototype=new n,h.prototype.write=function(e){this.data.push(e),this._events.data&&this.emit("data",this.data[this.data.length-1]),this.data.size+=e.length},h.prototype.writeChunk=function(e){e.length>this.data.size&&this.write(e.slice(l.data.size))},l||(l=new h(r)),l.emit("response",l),f.xhr.onreadystatechange=function(){switch(f.xhr.readyState){case 4:l.statusCode||(l.statusCode=f.xhr.status),l.headers||(l.headers=f.parseHeaders()),l.writeChunk(f.xhr.responseText),l.emit("end");break;case 3:l.statusCode||(l.statusCode=f.xhr.status,l.headers=f.parseHeaders(),l.emit("ready")),l.writeChunk(f.xhr.responseText);break;case 2:f.xhr.status&&(l.statusCode=f.xhr.status,l.headers=f.parseHeaders(),l.emit("ready"));break;case 1:}};var p=t.protocol+"://"+t.hostname+":"+t.port+t.path;console.log("Ajax Request %s %s",t.method,p),f.xhr.open(t.method,p,!0),Object.keys(t.headers).forEach(function(e){e=e.toLowerCase(),o.indexOf(e)<0&&f.xhr.setRequestHeader(e,t.headers[e])})}var t=typeof window=="object",n=e("./emitter"),r=e("./extend"),s=t?function(){var e,t;if(typeof window.XMLHttpRequest!="undefined")return window.XMLHttpRequest;if(typeof window.ActiveXObject!="undefined"){e="ActiveXObject";var n=["Msxml2.XMLHTTP.6.0","Msxml2.XMLHTTP.3.0","Microsoft.XMLHTTP"];for(var r=0,s=n.length;r<s;r++)try{return new window.ActiveXObject(n[r]),window.ActiveXObject(n[r])}catch(o){}throw i("NOXHR","XHR ActiveXObject failed")}throw i("NOXHR","XHR support not found")}():"node",o=["accept-charset","accept-encoding","access-control-request-headers","access-control-request-method","connection","content-length","cookie","cookie2","content-transfer-encoding","date","expect","host","keep-alive","origin","referer","te","trailer","transfer-encoding","upgrade","user-agent","via"];return u.prototype=new n,u.prototype.write=function(e){this.buffer.push(e)},u.prototype.end=function(e){this.xhr.send(this.buffer.length>0?this.buffer:null)},u.prototype.parseHeaders=function(){var e={},t,n,r,i=this.xhr.getAllResponseHeaders();return i.toLowerCase().split("\n").forEach(function(i){r=i.indexOf(":"),t=i.slice(0,r).replace(/^[\s]+|[\s]+$/g,""),n=i.slice(r+1,i.length).replace(/^[\s]+|[\s]+$/g,""),t&&t.length&&(e[t]=n)}),e},u}),define("request",["require","./emitter","./ajax"],function(e){var t=e("./emitter"),n=e("./ajax");return function(e){function r(t,r,i,s){function c(e,t,n){o.error={code:t,message:n},s?s(e&&t,e?n:o.result||o.data,o.headers):e?o.emit("error",o.error):o.emit("result",o.result||o.data,o.headers)}var o=this,u=[],a=i&&!i.length?JSON.stringify(i):null,f=e.extend(!0,{path:r,headers:{"Content-Type":"application/json","Content-Length":a?a.length:i&&i.length?i.length:0}},t,e.config.server),l=(new n(f,function(e){typeof e.data!="object"&&(e.data=[],e.on("data",function(t){e.data.push(t)})),e.on("end",function(){o.headers=e.headers;if(e.data.length>0)try{o.result=JSON.parse(e.data)}catch(t){o.data=e.data}o.result?c(o.result.error,e.statusCode,o.result.errorMessage):(e.error===undefined&&(e.error=!0),c(e.error,e.statusCode,e.message))})})).on("error",function(e){c(!0,e.code,e.message)});i&&l.write(a?a:i),l.end(),o.filter=function(e,t){var n={},r=[];typeof e=="string"?r=e.split(/[\s,]+/):typeof e=="array"?r=e:r=Array.prototype.slice.call(e),r.forEach(function(e){o.result[e]&&(n[e]=o.result[e])}),o.result=n,t&&t(o.result)}}return r.prototype=new t,{post:function(e,t,n){return new r({method:"POST"},e,t,n)},get:function(e,t){return new r({method:"GET"},e,null,t)},put:function(e,t,n){return new r({method:"PUT"},e,t,n)},"delete":function(e,t){return new r({method:"DELETE"},e,null,t)},patch:function(e,t,n){return new r({method:"PATCH"},e,t,n)},head:function(e,t){return new r({method:"HEAD"},e,null,t)},raw:function(e,t,n,i){return new r(e,t,n,i)}}}}),define("api/cursor",["require"],function(e){return function(e){var t="/_api/cursor/";return{get:function(n,r){return e.put(t+n,{},r)},create:function(n,r){return e.post(t,n,r)},query:function(t,n){return e.post("/_api/query",t,n)},explain:function(t,n){return e.post("/_api/explain",t,n)},"delete":function(n,r){return e.delete(t+n,r)}}}}),define("api/collection",["require"],function(e){return function(e){var t="/_api/collection/";return{create:function(){var n=e.config.name,r={},i,s=0;return typeof arguments[s]=="string"&&(n=arguments[s++]),typeof arguments[s]=="object"&&(r=arguments[s++]),typeof arguments[s]=="function"&&(i=arguments[s++]),r.name||(r.name=n),e.post(t,r,i)},get:function(n,r){return e.get(t+n,r)},"delete":function(n,r){return e.delete(t+n,r)},truncate:function(n,r){return e.put(t+n+"/truncate",null,r)},count:function(n,r){return e.get(t+n+"/count",r)},figures:function(n,r){return e.get(t+n+"/figures",r)},list:function(n){return e.get(t,n)},load:function(n,r){return e.put(t+n+"/load",null,r)},unload:function(n,r){return e.put(t+n+"/unload",null,r)},rename:function(n,r,i){return e.put(t+n+"/rename",r,i)},getProperties:function(n,r){return e.get(t+n+"/properties",r)},setProperties:function(n,r,i){return e.put(t+n+"/properties",r,i)}}}}),define("api/document",["require"],function(e){return function(e){function r(t,n,r,i){var s={};return s[t]=JSON.stringify(r),e.raw({headers:s},n,null,i)}function i(t,n,r,i,s){var o={};return o[t]=JSON.stringify(r),e.raw({method:"PUT",headers:o},n,i,s)}var t="/_api/document/",n="/_api/document?collection=";return{create:function(){var t=e.config.name,r={},i="",s,o=0;return typeof arguments[o]=="boolean"&&(i="&createCollection=true",o++),typeof arguments[o]=="string"&&(t=arguments[o++]),typeof arguments[o]=="object"&&(r=arguments[o++]),typeof arguments[o]=="function"&&(s=arguments[o++]),e.post(n+t+i,r,s)},create_:function(){var t=e.config.name,r={},i,s=0;return typeof arguments[s]=="string"&&(t=arguments[s++]),typeof arguments[s]=="object"&&(r=arguments[s++]),typeof arguments[s]=="function"&&(i=arguments[s++]),e.post(n+t+"&createCollection=true",r,i)},get:function(n,r){return e.get(t+n,r)},getIfNoneMatch:function(e,n,i){return r("If-None-Match",t+e,n,i)},getIfMatch:function(e,n,i){return r("If-Match",t+e,n,i)},put:function(n,r,i){return e.put(t+n,r,i)},putIfNoneMatch:function(e,n,r,s){return i("if-none-match",t+e,n,r,s)},putIfMatch:function(e,n,r,s){return i("if-match",t+e,n,r,s)},head:function(n,r){return e.head(t+n,r)},patch:function(n,r,i){return e.patch(t+n,r,i)},"delete":function(n,r){return e.delete(t+n,r)},list:function(){var t=e.config.name,r,i=0;return typeof arguments[i]=="string"&&(t=arguments[i++]),typeof arguments[i]=="function"&&(r=arguments[i++]),e.get(n+t,r)}}}}),define("api/index",["require"],function(e){return function(e){var t="/_api/index/",n="/_api/index?collection=";return{get:function(n,r){return e.get(t+n,r)},create:function(){var t=e.config.name,r={},i,s=0;return typeof arguments[s]=="string"&&(t=arguments[s++]),typeof arguments[s]=="object"&&(r=arguments[s++]),typeof arguments[s]=="function"&&(i=arguments[s++]),e.post(n+t,r,i)},"delete":function(n,r){return e.delete(t+n,r)},list:function(){var t=e.config.name,r,i=0;return arguments.length>0&&(typeof arguments[i]=="string"&&(t=arguments[i++]),typeof arguments[i]=="function"&&(r=arguments[i++])),e.get(n+t,r)}}}}),define("api/edge",["require"],function(e){return function(e){function i(t,n,r,i){var s={};return s[t]=JSON.stringify(r),e.raw({headers:s},n,null,i)}function s(t,n,r,i,s){var o={};return o[t]=JSON.stringify(r),e.raw({method:"PUT",headers:o},n,i,s)}var t="/_api/edge/",n="/_api/edge?collection=",r="/_api/edges/";return{get:function(n,r){return e.get(t+n,r)},getIfNoneMatch:function(e,n,r){return i("If-None-Match",t+e,n,r)},getIfMatch:function(e,n,r){return i("If-Match",t+e,n,r)},create:function(){var t,r,i,s={},o,u=0;return typeof arguments[u]=="string"&&(t=arguments[u++]),typeof arguments[u]=="string"&&(r=arguments[u++]),typeof arguments[u]=="string"&&(i=arguments[u++]),typeof arguments[u]=="object"&&(s=arguments[u++]),typeof arguments[u]=="function"&&(o=arguments[u++]),i||(i=r,r=t,t=e.config.name),e.post(n+t+"&from="+r+"&to="+i,s,o)},put:function(n,r,i){return e.put(t+n,r,i)},putIfNoneMatch:function(e,n,r,i){return s("if-none-match",t+e,n,r,i)},putIfMatch:function(e,n,r,i){return s("if-match",t+e,n,r,i)},head:function(n,r){return e.head(t+n,r)},patch:function(n,r,i){return e.patch(t+n,r,i)},"delete":function(n,r){return e.delete(t+n,r)},list:function(){var t,n,i,s,o=0;arguments.length>0&&(typeof arguments[o]=="string"&&(t=arguments[o++]),typeof arguments[o]=="string"&&(n=arguments[o++]),typeof arguments[o]=="string"&&(i=arguments[o++]),typeof arguments[o]=="function"&&(s=arguments[o++])),i||(i=n||"any",n=t,t=e.config.name);var u="?vertex="+n+"&direction="+i;return e.get(r+t+u,s)}}}}),define("api/key",["require"],function(e){return function(e){function r(t,n,r,i,s){var o={},u;return r.expires==="object"?u=r.expires:u=new Date(Date.parse(r.expires,"yyyy-MM-dd HH:MM:SS")),o["x-voc-expires"]=u.toISOString(),r.extended&&(o["x-voc-extended"]=JSON.stringify(r.extended)),e.raw({method:t,headers:o},n,i,s)}function i(e){return e.replace(/^[.\/]*/,"")}var t="/_api/key/",n="/_api/keys/";return{get:function(){var n=e.config.name,r,s,o=0;return typeof arguments[o+1]=="string"&&(n=arguments[o++]),typeof arguments[o]=="string"&&(r=arguments[o++]),typeof arguments[o]=="function"&&(s=arguments[o++]),e.get(t+n+"/"+i(r),s)},create:function(){var n=e.config.name,s,o={},u={},a,f=0;return typeof arguments[f+1]=="string"&&(n=arguments[f++]),typeof arguments[f]=="string"&&(s=arguments[f++]),o=arguments[f++],u=arguments[f++],typeof arguments[f]=="function"&&(a=arguments[f++]),r("POST",t+n+"/"+i(s),o,u,a)},put:function(){var n=e.config.name,s,o={},u={},a,f=0;return typeof arguments[f+1]=="string"&&(n=arguments[f++]),typeof arguments[f]=="string"&&(s=arguments[f++]),o=arguments[f++],u=arguments[f++],typeof arguments[f]=="function"&&(a=arguments[f++]),r("PUT",t+n+"/"+i(s)+"?create=1",o,u,a)},list:function(){var t=e.config.name,r,s,o=0;return typeof arguments[o+1]=="string"&&(t=arguments[o++]),typeof arguments[o]=="string"&&(r=arguments[o++]),typeof arguments[o]=="function"&&(s=arguments[o++]),e.get(n+t+"/"+i(r),s)},"delete":function(){var n=e.config.name,r,s,o=0;return typeof arguments[o+1]=="string"&&(n=arguments[o++]),typeof arguments[o]=="string"&&(r=arguments[o++]),typeof arguments[o]=="function"&&(s=arguments[o++]),e.delete(t+n+"/"+i(r),s)}}}}),define("api/session",["require"],function(e){return function(e){function t(t){var n="/_admin/user-manager/session";e.post(n,null,t)}return{login:function(n){t(function(t,r){t&&n(t,r);if(e.config.user&&e.config.user.length>0){var i="/_admin/user-manager/session/"+r.sid+"/login",s={user:e.config.user,password:e.config.pass};return e.put(i,s,function(t,r){t||(e._sid=r.sid,e._rights=r.rights),n&&n.apply(this,arguments)})}n&&n(0,r)})},logout:function(t){var n="/_admin/user-manager/session/"+e._sid+"/logout";return e.put(n,null,function(){e._sid=undefined,e._rights=undefined,t.apply(this,arguments)})},users:function(t){var n="/_admin/user-manager/users";return e.get(n,t)},createUser:function(t,n,r,i){var s="/_admin/user-manager/user/"+n,o=e.hashPass(r),u={role:t,password:o};return e.post(s,u,i)},changePass:function(t,n){var r="/_admin/user-manager/session/"+e._sid+"/password";return e.put(r,{password:e.hashPass(t)},n)}}}}),define("api/admin",["require"],function(e){return function(e){var t="/_admin/";return{status:function(n){return e.get(t+"status",n)},log:function(){var n="",r,i=0;return typeof arguments[i]=="string"&&(severity="?level="+arguments[i++]),typeof arguments[i]=="object"&&Object.keys(arguments[i++]).forEach(function(e){severity+=severity.length?"&":"?",severity+=e+"="+arguments[i][e]}),typeof arguments[i]=="function"&&(r=arguments[i++]),e.get(t+"log"+severity,r)},getConfig:function(n){return e.get(t+"config/configuration",n)},describeConfig:function(n){return e.get(t+"config/description",n)},listUsers:function(n){return e.get(t+"user-manager/users",n)},getUser:function(n,r){return e.get(t+"user-manager/user/"+n,r)}}}}),define("api/simple",["require"],function(e){return function(e){function i(e,t){return typeof t=="object"&&Object.keys(t).forEach(function(i){switch(i){case"from":e.left=t[i],e.closed=!0;break;case"to":e.right=t[i],e.closed=!0;break;default:e[i]=t[i]}n&&!e.skip&&(e.skip=n),r&&!e.limit&&(e.limit=r)}),e}var t="/_api/simple/",n,r;return{list:function(){var n={collection:e.config.name},r=0,s,o;return typeof arguments[r]=="string"&&(n.collection=arguments[r++]),typeof arguments[r]=="object"&&(s=arguments[r++]),typeof arguments[r]=="function"&&(o=arguments[r++]),e.put(t+"all",i(n),o)},example:function(){var n={collection:e.config.name},r=0,s,o;return typeof arguments[r]=="string"&&(n.collection=arguments[r++]),typeof arguments[r]=="object"&&typeof arguments[r+1]=="object"&&(s=arguments[r++]),typeof arguments[r]=="object"&&(n.example=arguments[r++]),typeof arguments[r]=="function"&&(o=arguments[r++]),e.put(t+"by-example",i(n),o)},first:function(){var n={collection:e.config.name},r=0,i,s;return typeof arguments[r]=="string"&&(n.collection=arguments[r++]),typeof arguments[r]=="object"&&(n.example=arguments[r++]),typeof arguments[r]=="function"&&(s=arguments[r++]),e.put(t+"first-example",n,s)},range:function(){var n={collection:e.config.name},r=0,s,o;return typeof arguments[r]=="string"&&(n.collection=arguments[r++]),typeof arguments[r]=="object"&&(s=arguments[r++]),typeof arguments[r]=="function"&&(o=arguments[r++]),e.put(t+"range",i(n),o)},near:function(){var n={collection:e.config.name},r=0,s,o;return typeof arguments[r]=="string"&&(n.collection=arguments[r++]),typeof arguments[r]=="object"&&(s=arguments[r++]),typeof arguments[r]=="function"&&(o=arguments[r++]),e.put(t+"near",i(n),o)},within:function(){var n={collection:e.config.name},r=0,s,o;return typeof arguments[r]=="string"&&(n.collection=arguments[r++]),typeof arguments[r]=="object"&&(s=arguments[r++]),typeof arguments[r]=="function"&&(o=arguments[r++]),e.put(t+"within",i(n),o)},skip:function(e){n=e},limit:function(e){r=e}}}}),define("arango",["require","./query","./extend","./emitter","./request","./api/cursor","./api/collection","./api/document","./api/index","./api/edge","./api/key","./api/session","./api/admin","./api/simple"],function(e){function i(){function u(e){var t=r.sha256hex;return e&&e.length>0?e.length===64?e:t(e):""}var e=this,t={},i=0;this.extend=r.extend;if(typeof arguments[i]=="string"){var s=/^(?:([A-Za-z]+):)?(\/{0,3})(?:([^\x00-\x1F\x7F:]+)?:?([^\x00-\x1F\x7F:]*)@)?([0-9.\-A-Za-z]+)(?::(\d+))?(?:\/([^?#]*))$/,o=s.exec(arguments[i++]);t.protocol=o[1],t.user=o[3],t.pass=o[4],t.host=o[5],t.port=o[6],t.name=o[7]}typeof arguments[i]=="object"&&this.extend(t,arguments[i++]),typeof arguments[i]=="function"&&(this.callback=arguments[i++]),this.config={server:{protocol:t.protocol||(n?n.protocol.split(":")[0]:"http"),hostname:t.host||(n?n.hostname:"127.0.0.1"),port:parseInt(t.port,10)||(n?n.port:8529)},user:t.user||"",_pass:t.pass||"",name:t.name||""},Object.defineProperty(this.config,"pass",{get:function(){return this._pass},set:function(e){this._pass=u(e)}}),this.hashPass=u,this.config._pass.length!==64&&(this.config.pass=this.config._pass);for(var a in r.api)this[a]=r.api[a](this);var f=r.request(this);for(var l in f)this[l]=f[l];this.query=r.query(this)}var t=typeof window=="object"&&window.hasOwnProperty("location"),n=t?window.location:!1,r={};return r.query=e("./query"),r.extend=e("./extend"),r.emitter=e("./emitter"),r.request=e("./request"),r.sha256hex=function(e){return e},r.api={cursor:e("./api/cursor"),collection:e("./api/collection"),document:e("./api/document"),index:e("./api/index"),edge:e("./api/edge"),key:e("./api/key"),session:e("./api/session"),admin:e("./api/admin"),simple:e("./api/simple")},{Connection:i}})